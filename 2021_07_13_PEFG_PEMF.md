# Apresentação

Tudo bem, Tarsila. Aqui vai um script detalhado do que vamos fazer, certinho. Espero que curta tanto a nálise quanto o programa. Vou dividir em alguns tópicos pra gente entender melhor, certo.
- Preparar o dados;
- Análise de suficiência amostral;
- Análise de variância entre as UCs;
- Diversidades das UCs.

## Preparar os dados
#### Informar o R
Aqui, é importante indicar qual pasta será usada para a análise. Primeiro precisamos indicar a pasta escrevendo o caminho dela dentro do seu computador. Algo como C://usuário.... dentro das aspas. Abaixo o meu:
```
getwd()
setwd("/home/user/Área de Trabalho/Bio/projeto_publ/2021_tarsila") 
```
#### Pacotes e entradas de arquivos
Vamos instalar logo vários pacotes que possivelmente utilizaremos para selecionar dados, afzer gráficos e tal.
```
if(!require(pacman, quietly = TRUE))(install.packages("pacman")) 
pacman::p_load(magrittr,dplyr) 
pacman::p_load(ggplot2, devtools, ggrepel, graphics) 
pacman::p_load(vegan) 
```

#### Caregar Planilha
```
pacman::p_load(openxlsx) 
caminho.do.arquivo <- "/home/user/Área de Trabalho/Bio/projeto_publ/2021_tarsila/2021_07_06_tabela_atualizada.xlsx"
planilhatotal <- read.xlsx(caminho.do.arquivo, 
                           sheet = 1,
                           colNames = T, 
                           na.strings = "NA") 
```                           

Vamos verificar se deu certo puxar a nossa tabela?

`head(planilhatotal)`

#### Corrigir planilha
Aqui vamos selecionar os dados. Primeiro vamos atribuir nossa tabela e denominar p2. 

`p2 <- planilhatotal`

Depois vamos selecionar os dados que queremos. Precisar ser PEFG e PEMF. Deu alguns exemplos que podem ser suados juntos. O primeiro eu selecinei aqueles coletados na orientação da Leo

`p2 <- subset(p2, RecordedBy == "Leonora Pires Costa")`

Depois em Dados primários, cidade de Castelo e tal.
```
p2 <- subset(p2, Data == "Primary data") 
p2 <- subset(p2, City == "Castelo") 
```

Aqui tiramos as células NA ou vazias das colunas de dia, ordem e espécie.
```
p2 <- subset(p2, !is.na(Day))
p2 <- subset(p2, !is.na(Order)) 
p2 <- subset(p2, !is.na(Species)) 
```

`head(p2)`

#### Teste de plots
Um teste simples

`ts.plot(p2$Day)`

Um gráfico um pouco mais elaborado. Vamos plotar as espécies no eixo y e as altitudes no eixo x, com cores vamos diferenciar as UCs.
```
ggplot(p2, aes(x = Altitude, y = Species, colour = Locality)) + 
  geom_boxplot() +
  #geom_smooth(method = lm, se = TRUE) + 
  theme_classic()
#ggsave("1.Species/altitude.png",width = 10, height = 6, dpi = 300)
```

Parece que deu tudoc erto, então vamos prosseguir,

## Análise de suficiência amostral
Vamos começar com uma análise para ver a suficiência amostral de cada local, tudo bem. Primeiro um pacote que permite criar tabelas a partir das nossas.

`pacman::p_load(reshape2)`

Agora vamos selecionar a UC. Primeiro para PEFG

`p3 <- subset(p2, Locality == "PEFG")`

Vamos montar uma tabela utilizando a data de coleta pelas espécies coletadas. Utilizamremos como base a planilha p3 só com PEFG e nominar de acum
```
acum<-reshape2::dcast(p3, Year + Month + Day ~ Species)
acum=data.frame(acum, row.names = 1)
```

Vamos ver?

`head(acum)`


Vamos deixar apenas a coluna de dias:
```
excluir <- c("Year", "Month")
acum <- acum[,!(names(acum)%in% excluir)]
head(acum)
```

Agora um gráfico simples de acumualção

```
acumplot<-specaccum(acum) 
acumplot
plot(acumplot)
```

Fazer aquele upgride aqui
```
plot(acumplot,ci.type="poly",col="black",lwd=2,ci.lty=0,ci.col="lightgrey",ylab="Riqueza",
     xlab="Dias amostrais",main="Curva de acumulação de espécies para o Parque estadual do Forno Grande",las=1,font=1.5,font.lab=1.5,cex.lab=1,cex.axis=1) 
```

### PEMF
Fazer de novo, só lembrar de trocar em p3... Locality == "PEMF") e na legenda.


## Análise de variância entre as UC
Vamos ver se nossos dados são de distribuição normal ou não. Primeiro vamos instalar o pacote para as análises.

`pacman::p_load(ExpDes, ExpDes.pt, fitdistrplus)`

Depois montar uma tabel onde teremos os dias de coleta e as localidade por sua abundância.

`p3<-reshape2::dcast(p3, Date + Locality ~ Class, value.var = "individualCount")`

Agora vamos rodar uma análise mútipla, ela vai ver a viariação entre as localidade e os sucesso de amostragem (ANOVA). Análise de Variância (ANOVA) trata-se de um método estatı́stico que perimte realizar comparações simultâneas entre duas ou mais médias, ou seja, permite testar hipóteses sobre médias de distintas populações. 
Pressuposto: 
- Todas as observações devem ser independentes; 
- As observações em cada grupo devem possuir uma distribuição aproximadamente normal; 
- As variâncias em cada grupo devem ser aproximadamente iguais.

```
dicalt <- lm(Mammalia ~ Locality, data = p3) 
anova(dicalt)
summary(dicalt)
```

Percebe-se, em Pr(>|F|) que p é muito pequeno, vai em desacordo com a hipótese nula em que as duas localidades são iguais, então existe diferença no sucesso de amostragem entre as UCs.

Vamos ver isso em gráfico que mostra por dia de coleta quanto de abudância tivemos para cada UC.
```
ggplot(p3, aes(x = Date, y = Mammalia, fill = Locality)) + 
  geom_point(size = 4, alpha = 0.7) +
  geom_smooth(method = lm, se = TRUE) + 
  scale_x_continuous(breaks = 0:20) +
  theme_classic()
#ggsave("1.Abundancia  por data.png",width = 10, height = 6, dpi = 300)
```
Uma forma de ver a diferenã entre as localidades e colocando em um gráfico. Primeiro os pacotes, claro.
```
pacman::p_load(ggpubr,reshape, psych, exactRankTests) 
install.packages(exactRankTests)`
```

Fazendo um boxplot das abundância entre as UCs fica evidente que existe uma grande diferença.
```
ggboxplot(p3, x = "Date", y = "Mammalia", color = "Locality", 
    palette = c("#00AFBB", "#E7B800"), 
    fill = "Locality", 
    order = c("PEMF", "PEFG"), 
    ylab = "Abundância", xlab = "Locality")
```

Mas, pensando nas premissas, será que os ddos são normais? Vamos testar isso com os seguintes pacotes.
`pacman::p_load(fitdistrplus)`

Primeiro PEMF 
```
p4 <- subset(p3, Locality == "PEFG")
shapiro.test(p3$Mammalia) 
```
A Hipótese nula nos dia que a distribuição é normal. Essa hipótese foi negada, então os dados não são normais. Vamos ver isso em gráfico?
```
fit.MF.normal <- fitdist(p4$Mammalia, "norm") #gráfico de distribuição normal / Altitude distribuição normal
denscomp(fit.MF.normal, addlegend=TRUE)
```
Bom, as abundâncias para PEMF não estão em ditribuição normal, sendo que a maioria da abundãncia por dia era de 5 a 10 indivíduos. mas chegando a 35.

Teste o mesmo para PEMF, lembrado de trocar em p4 o PEFG para PEMF. 

Nesse caso, uma outra análise de variância é necessário, no caso um teste de Wilcox. Para isso precisamos selecionar os dados.
Primeiro para PEMF
```
PEMF <- subset(p3, Locality == "PEMF")
PEMF <- sample(PEMF$Mammalia,size=40, replace=TRUE)
```
Agora para PEFG
```
PEFG <- subset(p3, Locality == "PEFG")
PEFG <- sample(PEFG$Mammalia,size=40, replace=TRUE)
```
Por fim o teste.
```
res <- wilcox.exact(PEFG,PEMF, paired = TRUE) 
res
```
Note que o p deu muito pequeno, negando a hipótese nula de que são iguais, ou seja, são realmente diferentes.



####### Diversidade ##########

#criar tabelas para análise (vai ter mensagem, mas funciona)
pacman::p_load(reshape2)

## Abundância total Total
abund<-reshape2::dcast(planilhatotal, Species ~ Class)
#abund
abundt=t(abund)
specnumber(abundt) #Riqueza de 41 espécies

## UCs

#UCs
UCtotal<-reshape2::dcast(planilhatotal, Locality ~ Class)
#UCtotal #abundância por UUC / pode ou não precisar de fazer data.frame

#UCs por Espécie
local<-reshape2::dcast(planilhatotal, Species ~ Locality)
local=data.frame(local, row.names=1)
#local #Diveraidade espécie por UC
local[is.na(local)] <- 0
localt=t(local)
#Riqueza
specnumber<-specnumber(localt)
specnumber #Riqueza por UC
barplot(specnumber)
#Cuva de abundância de UCs
rarecurve(localt,col="blue",cex=1,xlab="Abundance",ylab="Richness",main="Abundance Curve") #abundância localidade

#Diversidade  Local 
local<-reshape2::dcast(planilhatotal, Locality ~ Species)
local=data.frame(local, row.names=1)
H <- diversity(local)
H #shannon
#Dominancia (mede a probabilidade de 2 (dois) individuos, selecionados ao acaso na amostra, pertencer a mesma especie)
simp <- diversity(local, "simpson")
simp #simpson
#inverso do simpson
invsimp <- diversity(local, "inv")
invsimp #pielou
## Unbiased Simpson (Hurlbert 1971, eq. 5) with rarefy:
unbias.simp <- rarefy(local, 2) - 1
unbias.simp
## Fisher alpha
alpha <- fisher.alpha(local)
alpha
## Plot all
#pairs(cbind(H, simp, invsimp, unbias.simp, alpha), pch="+", col="blue")
## Species richness (S) and Pielou's evenness (J):
S <- specnumber(local) ## rowSums(BCI > 0) does the same...
S
J <- H/log(S)
J

#gráfico
local<-reshape2::dcast(planilhatotal, Locality ~ Species)
local<-data.frame(local, H, simp, unbias.simp, alpha, S, J)
#hist(local$alpha)

ggplot(local, aes(x = H, y = S, color = Locality)) + 
  geom_point(size=12)+ 
  #geom_smooth(method = lm, se = FALSE)
  geom_text(data = data.frame(),
            aes(label = local$Locality),
            col = 'black',
            size = 5) +
  #geom_boxplot() + 
    ggtitle("Diversity") +
  xlab("Shannon diversity") +
  ylab("Richness") +
  theme(legend.position="none")
  
#cluster
pacman::p_load("ade4")
local<-reshape2::dcast(planilhatotal, Locality ~ Species)
local=data.frame(local, row.names=1)
d <- dist.binary(local, method = 1, diag = FALSE, upper = FALSE) #method 1 is Jaccard index (1901) S3 coefficient of Gower & Legendre
hc <- hclust(d)               # apply hierarchical clustering 
plot(hc, labels=local$ID)    # plot the dendrogram

## Altitude

#Altitude Total
alt<-reshape2::dcast(planilhatotal, Altitude ~ Class)
#alt #Abundância por altitude
#Distribuição dos registros na altitude
#descdist(alt$Mammalia, discrete = F, graph = T) #Distribuição não normal dos dados de diversidade
#fit.MF.normal <- fitdist(alt$Mammalia, "norm") #gráfico de distribuição normal
#plot(fit.MF.normal) #a maioria das altitudes apresentam menos de 50 registros
#variância Altitude
#dicalt <- lm(alt$Mammalia ~ alt$Altitude, data = alt) #relação de diversidade e altitude
#anova(dicalt) #h0 = não variável/ F= diferença das médias
  #h0 quase significatico, sem variação da quantidade de registro entre as altitudes
#summary(dicalt) #R = explicação (mais perto de 1 melhor) 
  #deu muito baixo o R
  #p não significativo, não existe variância entre as altitudes

#Faixas altitudinais
faixa<-reshape2::dcast(planilhatotal, Band ~ Species)
faixa=data.frame(faixa,row.names=1)
#faixa #Diversidade espécie por faixa
#Abundância por Faixa
abund<-rowSums(faixa) #abunância por faixa
abund
ts.plot(abund)
#Riqueza
specnumber<-specnumber(faixa)
specnumber #Riqueza por Faixa
ts.plot(specnumber)
barplot(specnumber)
#Gráfico de Acumulação por Faixa
acumplot<-specaccum(faixa) #dados de acumulação
acumplot
plot(acumplot) #curva simples
plot(acumplot,ci.type="poly",col="black",lwd=2,ci.lty=0,ci.col="lightgrey",ylab="Riqueza",
     xlab="Faixa de Altitude",main="Curva de Acumulação de Espécies",las=1,font=1.5,font.lab=1.5,cex.lab=1,cex.axis=1) #curva clássica
#Rarefacao faixas
sp1<-specaccum(faixa,method="rarefaction")
sp2<-specaccum(faixa, method="exact")
sp3<-specaccum(faixa,method="random")
sp4<-specaccum(faixa,method="collector")
#Rarefacao Graficos
#par(mgp=c(1,1,0)) #exportar a imagem
#png(filename="/home/victor/Área de Trabalho/Bio/projeto_publ/2020_santa_teresa/acum4.png",width=800,height=600) #local e tmamanho
par(mfrow=c(2,2)) 
plot(sp1, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightblue",xlab="Amostras",ylab="Rarefação")
plot(sp2, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightgrey",xlab="Amostras",ylab="Riqueza Esperada")
plot(sp3, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="yellow",xlab="Amostras",ylab="Sítios Aleatórios")
plot(sp4, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightblue",xlab="Amostras",ylab="Curva do Coletor")
par(mfrow=c(1,1)) #compilado de curvas
#dev.off()

#Diversidade  Local 
H <- diversity(faixa)
H #shannon
#Dominancia (mede a probabilidade de 2 (dois) individuos, selecionados ao acaso na amostra, pertencer a mesma especie)
simp <- diversity(faixa, "simpson")
simp #simpson
#inverso do simpson
invsimp <- diversity(faixa, "inv")
invsimp #pielou
## Unbiased Simpson (Hurlbert 1971, eq. 5) with rarefy:
unbias.simp <- rarefy(faixa, 2) - 1
unbias.simp
## Fisher alpha
alpha <- fisher.alpha(faixa)
alpha
## Plot all
#pairs(cbind(H, simp, invsimp, unbias.simp, alpha), pch="+", col="blue")
### Species richness (S) and Pielou's evenness (J):
S <- specnumber(faixa) ## rowSums(BCI > 0) does the same...
S
J <- H/log(S)
J
#gráfico
faixa<-reshape2::dcast(planilhatotal, Band ~ Species)
faixa<-data.frame(faixa, H, simp, unbias.simp, alpha, S, J)
#hist(faixa$alpha)

ggplot(faixa, aes(x = H, y = S, color = Band)) + 
  geom_point(size=12)+
  geom_text(data = data.frame(),
            aes(label = faixa$Band),
            col = 'black',
            size = 5) +
  #geom_boxplot() +
  ggtitle("Diversity") +
  xlab("Shannon diversity") +
  ylab("Richness") +
  theme(legend.position="none")

#cluster
pacman::p_load("ade4")
faixa<-reshape2::dcast(planilhatotal, Band ~ Espécie)
faixa=data.frame(faixa, row.names=1)
d <- dist.binary(faixa, method = 1, diag = FALSE, upper = FALSE) #method 1 is Jaccard index (1901) S3 coefficient of Gower & Legendre
hc <- hclust(d)               # apply hierarchical clustering 
plot(hc, labels=local$ID)    # plot the dendrogram


#Altitude por espécie
altitude<-reshape2::dcast(planilhatotal, Altitude ~ Species)
altitude=data.frame(altitude,row.names=1)
#altitude #Diversidade espécie por faixa
#Riqueza
specnumber<-specnumber(altitude)
riqueza <- data.frame(specnumber, altitude)
plot(specnumber)
ts.plot(specnumber)
barplot(specnumber)
#Gráfico de acumulação por altitude
acumplot<-specaccum(altitude) #dados de acumulação
acumplot
plot(acumplot) #curva simples
plot(acumplot,ci.type="poly",col="black",lwd=2,ci.lty=0,ci.col="lightgrey",ylab="Riqueza",
     xlab="Altitude",main="Curva de Acumulação de Espécies",las=1,font=1.5,font.lab=1.5,cex.lab=1,cex.axis=1) #curva clássica
#Rarefacao altitude
sp1<-specaccum(altitude,method="rarefaction")
sp2<-specaccum(altitude, method="exact")
sp3<-specaccum(altitude,method="random")
sp4<-specaccum(altitude,method="collector")
#Rarefacao Graficos
#par(mgp=c(1,1,0)) #exportar a imagem
#png(filename="/home/victor/Área de Trabalho/Bio/projeto_publ/2020_santa_teresa/acum4.png",width=800,height=600) #local e tmamanho
par(mfrow=c(2,2)) 
plot(sp1, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightblue",xlab="Amostras",ylab="Rarefação")
plot(sp2, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightgrey",xlab="Amostras",ylab="Riqueza Esperada")
plot(sp3, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="yellow",xlab="Amostras",ylab="Sítios Aleatórios")
plot(sp4, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightblue",xlab="Richness",ylab="Elevational Steps") #tentar separar os anos ggplot2
par(mfrow=c(1,1)) #compilado de curvas
#dev.off()
sp4<-specaccum(altitude,method="collector")
sp4<-data.frame(sp4$sites,sp4$richness)
  #arrange(desc(Sites)) %>% #organizador
ggplot(sp4, aes(x=sp4$sp4.sites, y=sp4$sp4.richness)) +
  geom_line(alpha=0.5) +
  geom_point(size=3) +
  ggtitle("Gradiente Altitudinal")

altitude<-reshape2::dcast(planilhatotal, Altitude ~ Species)
#altitude #Diversidade espécie por faixa
#Riqueza
specnumber<-specnumber(altitude)
riqueza <- data.frame(specnumber, altitude)

ggplot(riqueza, aes(x=Altitude, y=specnumber)) +
  geom_point() +
  geom_smooth(method = loess) +
  #ggtitle("Curva de regressão LOWESS da relação de riqueza por altitude") +
  xlab("Altitude") +
  ylab("Riqueza") +
  #theme(axis.title = element_text(size = 18),
  #axis.text = element_text(size = 16))+
  theme_classic() 

#ggsave("altvsrq.png",width = 7, height = 5, dpi = 600)

#Diversidade  Local 
H <- diversity(altitude)
H #shannon
#Dominancia (mede a probabilidade de 2 (dois) individuos, selecionados ao acaso na amostra, pertencer a mesma especie)
simp <- diversity(altitude, "simpson")
simp #simpson
#inverso do simpson
invsimp <- diversity(altitude, "inv")
invsimp #pielou
## Unbiased Simpson (Hurlbert 1971, eq. 5) with rarefy:
unbias.simp <- rarefy(altitude, 2) - 1
unbias.simp
## Fisher alpha
alpha <- fisher.alpha(altitude)
alpha
## Plot all
#pairs(cbind(H, simp, invsimp, unbias.simp, alpha), pch="+", col="blue")
## Species richness (S) and Pielou's evenness (J):
S <- specnumber(altitude) ## rowSums(BCI > 0) does the same...
J <- H/log(S)

#gráfico
altitude<-reshape2::dcast(planilhatotal, Altitude ~ Species)
altitude<-data.frame(altitude, H, simp, unbias.simp, alpha, S, J)
#hist(altitude$alpha)

ggplot(altitude, aes(x = S, y = Altitude, color = H)) + #não faz muito sentido, esforços diferentes
  geom_point(size=6)+
  #geom_text(data = data.frame(),
            #aes(label = altitude$H),
            #col = 'white',
            #size = 3) +
  #geom_boxplot() +
  ggtitle("Diversity") +
  xlab("Shannon diversity") +
  ylab("Elevation")

altitude<-reshape2::dcast(planilhatotal, Altitude ~ Species)
altitude=data.frame(altitude,row.names=1)
abund<-sort(colSums(altitude),decr=TRUE)
Abundância<-abund
sp4<-specaccum(altitude,method="collector")
altitude<-reshape2::dcast(planilhatotal, Altitude ~ Kingdom)
names(altitude)[grep('Animalia', names(altitude))] <- 'Abundance'
Shannon <- H
a<-data.frame(sp4$sites,sp4$richness,altitude,Shannon)

ggplot(a, aes(x = Altitude, y = sp4.richness)) + 
  geom_line(size=6, alpha=0.6, color="Gray")+
  geom_point(aes(size=Abundance, color=Shannon), alpha=0.3) +
  geom_label_repel(aes(label = sp4$richness), size=3, alpha=0.8, #funciona no zoom
                   box.padding   = 0.35, 
                   point.padding = 0.75,
                   max.overlaps = Inf,
                   segment.color = 'grey50') +
  scale_size(range = c(.1, 18), name = "Abundance") +
  #geom_text(aes(label = a$sp4.richness),col = 'black',size = 5) +
  ggtitle("Richness accumulation per altitude") +
  xlab("Altitude") +
  ylab("Richness") +
  theme(axis.title = element_text(size = 18),
        axis.text = element_text(size = 14))+
  theme(legend.position="right")


#ggsave("curva.png",width = 9, height = 5, dpi = 600)

#cluster
pacman::p_load("ade4")
altitude<-reshape2::dcast(planilhatotal, Altitude ~ Species)
altitude=data.frame(altitude, row.names=1)
d <- dist.binary(altitude, method = 1, diag = FALSE, upper = FALSE) #method 1 is Jaccard index (1901) S3 coefficient of Gower & Legendre
hc <- hclust(d)               # apply hierarchical clustering 

#par(mgp=c(1,1,0)) #exportar a imagem
#png(filename="/home/victor/Área de Trabalho/Bio/projeto_publ/2020_altitude/cluster.png",width=800,height=400) #local e tmamanho
plot(hc, labels=local$ID, xlab = "Clusters", ylab = "Jaccard index" ) # plot the dendrogram
#legend("top", "(557:1490m)", pch = FALSE, title = "Intermediary") #, bg = "transparent")
#legend("topright", "(45:153m)", pch = 1, title = "Bottom") #, bg = "transparent")
#legend("topleft", "(1800:2700m)", pch = FALSE, title = "Upper") #, bg = "transparent")
#dev.off()



#cem por espécie
altitude<-reshape2::dcast(planilhatotal, Cem ~ Species)
altitude=data.frame(altitude,row.names=1)
#altitude #Diversidade espécie por faixa
#Riqueza
specnumber<-specnumber(altitude)
specnumber
ts.plot(specnumber)
barplot(specnumber)
#Gráfico de acumulação por altitude
acumplot<-specaccum(altitude) #dados de acumulação
acumplot
plot(acumplot) #curva simples
plot(acumplot,ci.type="poly",col="black",lwd=2,ci.lty=0,ci.col="lightgrey",ylab="Riqueza",
     xlab="Altitude",main="Curva de Acumulação de Espécies",las=1,font=1.5,font.lab=1.5,cex.lab=1,cex.axis=1) #curva clássica
#Rarefacao altitude
sp1<-specaccum(altitude,method="rarefaction")
sp2<-specaccum(altitude, method="exact")
sp3<-specaccum(altitude,method="random")
sp4<-specaccum(altitude,method="collector")
#Rarefacao Graficos
#par(mgp=c(1,1,0)) #exportar a imagem
#png(filename="/home/victor/Área de Trabalho/Bio/projeto_publ/2020_santa_teresa/acum4.png",width=800,height=600) #local e tmamanho
par(mfrow=c(2,2)) 
plot(sp1, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightblue",xlab="Amostras",ylab="Rarefação")
plot(sp2, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightgrey",xlab="Amostras",ylab="Riqueza Esperada")
plot(sp3, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="yellow",xlab="Amostras",ylab="Sítios Aleatórios")
plot(sp4, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightblue",xlab="Richness",ylab="Elevational Steps") #tentar separar os anos ggplot2
par(mfrow=c(1,1)) #compilado de curvas
#dev.off()
sp4<-specaccum(altitude,method="collector")
sp4<-data.frame(sp4$sites,sp4$richness)
#arrange(desc(Sites)) %>% #organizador
ggplot(sp4, aes(x=sp4$sp4.sites, y=sp4$sp4.richness)) +
  geom_line(alpha=0.5) +
  geom_point(size=3) +
  ggtitle("Gradiente Altitudinal")

#Diversidade  Local 
H <- diversity(altitude)
H #shannon
#Dominancia (mede a probabilidade de 2 (dois) individuos, selecionados ao acaso na amostra, pertencer a mesma especie)
simp <- diversity(altitude, "simpson")
simp #simpson
#inverso do simpson
invsimp <- diversity(altitude, "inv")
invsimp #pielou
## Unbiased Simpson (Hurlbert 1971, eq. 5) with rarefy:
unbias.simp <- rarefy(altitude, 2) - 1
unbias.simp
## Fisher alpha
alpha <- fisher.alpha(altitude)
alpha
## Plot all
#pairs(cbind(H, simp, invsimp, unbias.simp, alpha), pch="+", col="blue")
## Species richness (S) and Pielou's evenness (J):
S <- specnumber(altitude) ## rowSums(BCI > 0) does the same...
J <- H/log(S)

#gráfico
altitude<-reshape2::dcast(planilhatotal, Cem ~ Species)
altitude<-data.frame(altitude, H, simp, unbias.simp, alpha, S, J)
#hist(altitude$alpha)

ggplot(altitude, aes(x = S, y = Cem, color = H)) + #não faz muito sentido, esforços diferentes
  geom_point(size=6)+
  #geom_text(data = data.frame(),
  #aes(label = altitude$H),
  #col = 'white',
  #size = 3) +
  #geom_boxplot() +
  ggtitle("Diversity") +
  xlab("Shannon diversity") +
  ylab("Elevation")

altitude<-reshape2::dcast(planilhatotal, Cem ~ Species)
altitude=data.frame(altitude,row.names=1)
abund<-sort(colSums(altitude),decr=TRUE)
Abundância<-abund
sp4<-specaccum(altitude,method="collector")
altitude<-reshape2::dcast(planilhatotal, Cem ~ Kingdom)
names(altitude)[grep('Animalia', names(altitude))] <- 'Abundance'
Shannon <- H
a<-data.frame(sp4$sites,sp4$richness,altitude,Shannon)

ggplot(a, aes(x = Cem, y = sp4.richness)) + 
  geom_line(size=6, alpha=0.6, color="Gray") + #geom_line(aes(group = sp4.sites))
  geom_point(aes(size=Abundance, color=Shannon), alpha=0.3) +
  geom_label_repel(aes(label = sp4$richness), size=4, alpha=0.8, #funciona no zoom
                   box.padding   = 0.35, 
                   point.padding = 0.75,
                   segment.color = 'grey50') +
  scale_size(range = c(.1, 18), name = "Abundance") +
  #geom_text(aes(label = a$sp4.richness),col = 'black',size = 5) +
  ggtitle("Richness accumulation per altitude") +
  xlab("Altitude") +
  ylab("Richness") +
  theme(axis.title = element_text(size = 18),
        axis.text = element_text(size = 14))+
  theme_classic() 

#ggsave("curvacem.png",width = 7, height = 5, dpi = 600)


#cluster
pacman::p_load("ade4")
altitude<-reshape2::dcast(planilhatotal, Cem ~ Species)
altitude=data.frame(altitude, row.names=1)
d <- dist.binary(altitude, method = 1, diag = FALSE, upper = FALSE) #method 1 is Jaccard index (1901) S3 coefficient of Gower & Legendre
hc <- hclust(d)               # apply hierarchical clustering 

#par(mgp=c(1,1,0)) #exportar a imagem
#png(filename="/home/victor/Área de Trabalho/Bio/projeto_publ/2020_altitude/clusterlg.png",width=800,height=400) #local e tmamanho
plot(hc, labels=local$ID, xlab = "Clusters", ylab = "Jaccard index" ) # plot the dendrogram
legend("top", "(0:700m)", pch = FALSE, title = "Bottom") #, bg = "transparent")
legend("topright", "(1000:1500m)", pch = 1, title = "Intermediary") #, bg = "transparent")
legend("topleft", "(1800:2700m)", pch = FALSE, title = "Upper") #, bg = "transparent")
#dev.off()

## Faixa

#Acumulação/faixa
acum<-reshape2::dcast(planilhatotal, Band_group ~ Species)
acum=data.frame(acum, row.names=1)
#acum #Diversidade espécie por ano
acum[is.na(acum)] <- 0 #transformar N/A em 0
acumt=t(acum) #transpose dos dados
#Abundãncia por ano
abund<-sort(colSums(acumt),decr=TRUE) #abunância por ano
abund
#Curva de acumulação por ano
rarecurve(acum,col="blue",cex=1,xlab="Tamanho amostral",ylab="Espécies",main="Curva de Abundância") #abundância espécie
rarecurve(acumt,col="blue",cex=0.75,xlab="Tamanho amostral",ylab="Espécies",main="Curva de Abundância") #abundância ano
#Gráfico de acumumulação por ano
acumplot<-specaccum(acum) #dados de acumulação
#acumplot
plot(acumplot) #curva simples
plot(acumplot,ci.type="poly",col="black",lwd=2,ci.lty=0,ci.col="lightgrey",ylab="Riqueza",
     xlab="Faixa",main="Curva de Acumulação de Espécies",las=1,font=1.5,font.lab=1.5,cex.lab=1,cex.axis=1) #curva clássica
#Rarefacao ano
acum=data.frame(acum, row.names=1)
sp1<-specaccum(acum,method="rarefaction")
sp2<-specaccum(acum, method="exact")
sp3<-specaccum(acum,method="random")
sp4<-specaccum(acum,method="collector")
#Rarefacao Graficos
#par(mgp=c(1,1,0)) #exportar a imagem
#png(filename="/home/victor/Área de Trabalho/Bio/projeto_publ/2020_santa_teresa/acum4.png",width=800,height=600) #local e tmamanho
par(mfrow=c(2,2)) 
plot(sp1, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightblue",xlab="Amostras",ylab="Rarefação")
plot(sp2, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightgrey",xlab="Amostras",ylab="Riqueza Esperada")
plot(sp3, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="yellow",xlab="Amostras",ylab="Sítios Aleatórios")
plot(sp4, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightblue",xlab="Amostras",ylab="Curva do Coletor")
par(mfrow=c(1,1)) #compilado de curvas
#dev.off()

#Group
#Faixas altitudinais
grupo<-reshape2::dcast(planilhatotal, Group ~ Species)
grupo=data.frame(grupo,row.names=1)
#grupo #Diversidade espécie por faixa
#Abundância por Faixa
abund<-rowSums(grupo) #abunância por faixa
abund

#Riqueza
specnumber<-specnumber(grupo)
specnumber #Riqueza por Faixa
ts.plot(specnumber)
barplot(specnumber)
#Gráfico de Acumulação por Faixa
acumplot<-specaccum(grupo) #dados de acumulação
acumplot
plot(acumplot) #curva simples
plot(acumplot,ci.type="poly",col="black",lwd=2,ci.lty=0,ci.col="lightgrey",ylab="Riqueza",
     xlab="Faixa de Altitude",main="Curva de Acumulação de Espécies",las=1,font=1.5,font.lab=1.5,cex.lab=1,cex.axis=1) #curva clássica
#Rarefacao faixas
sp1<-specaccum(grupo,method="rarefaction")
sp2<-specaccum(grupo, method="exact")
sp3<-specaccum(grupo,method="random")
sp4<-specaccum(grupo,method="collector")
#Rarefacao Graficos
#par(mgp=c(1,1,0)) #exportar a imagem
#png(filename="/home/victor/Área de Trabalho/Bio/projeto_publ/2020_santa_teresa/acum4.png",width=800,height=600) #local e tmamanho
par(mfrow=c(2,2)) 
plot(sp1, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightblue",xlab="Amostras",ylab="Rarefação")
plot(sp2, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightgrey",xlab="Amostras",ylab="Riqueza Esperada")
plot(sp3, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="yellow",xlab="Amostras",ylab="Sítios Aleatórios")
plot(sp4, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightblue",xlab="Amostras",ylab="Curva do Coletor")
par(mfrow=c(1,1)) #compilado de curvas
#dev.off()

#Diversidade  Local 
H <- diversity(grupo)
H #shannon
#Dominancia (mede a probabilidade de 2 (dois) individuos, selecionados ao acaso na amostra, pertencer a mesma especie)
simp <- diversity(grupo, "simpson")
simp #simpson
#inverso do simpson
invsimp <- diversity(grupo, "inv")
invsimp #pielou
## Unbiased Simpson (Hurlbert 1971, eq. 5) with rarefy:
unbias.simp <- rarefy(grupo, 2) - 1
unbias.simp
## Fisher alpha
alpha <- fisher.alpha(grupo)
alpha
## Plot all
#pairs(cbind(H, simp, invsimp, unbias.simp, alpha), pch="+", col="blue")
## Species richness (S) and Pielou's evenness (J):
S <- specnumber(grupo) ## rowSums(BCI > 0) does the same...
S
J <- H/log(S)
J
#gráfico
grupo<-reshape2::dcast(planilhatotal, Group ~ Species)
grupo<-data.frame(grupo, H, simp, unbias.simp, alpha, S, J)
#hist(grupo$alpha)

ggplot(grupo, aes(x = H, y = S)) + 
  geom_point(size=12)+
  geom_text(data = data.frame(),
            aes(label = grupo$S),
            col = 'white',
            size = 5) +
  #geom_boxplot() +
  ggtitle("Diversity") +
  xlab("Shannon diversity") +
  ylab("Richness") +
  theme(legend.position="none")

#cluster
pacman::p_load("ade4")
grupo<-reshape2::dcast(planilhatotal, Group ~ Species)
grupo=data.frame(grupo, row.names=1)
d <- dist.binary(grupo, method = 1, diag = FALSE, upper = FALSE) #method 1 is Jaccard index (1901) S3 coefficient of Gower & Legendre
hc <- hclust(d)               # apply hierarchical clustering 
plot(hc, labels=local$ID)    # plot the dendrogram


#Ecoregion
#Faixas altitudinais
eco<-reshape2::dcast(planilhatotal, Ecoregion ~ Species)
eco=data.frame(eco,row.names=1)
#eco #Diversidade espécie por faixa
#Abundância por Faixa
abund<-rowSums(eco) #abunância por faixa
abund
ts.plot(eco)
#Riqueza
specnumber<-specnumber(eco)
specnumber #Riqueza por Faixa
ts.plot(specnumber)
barplot(specnumber)
#Gráfico de Acumulação por Faixa
acumplot<-specaccum(eco) #dados de acumulação
acumplot
plot(acumplot) #curva simples
plot(acumplot,ci.type="poly",col="black",lwd=2,ci.lty=0,ci.col="lightgrey",ylab="Riqueza",
     xlab="Faixa de Altitude",main="Curva de Acumulação de Espécies",las=1,font=1.5,font.lab=1.5,cex.lab=1,cex.axis=1) #curva clássica
#Rarefacao faixas
sp1<-specaccum(eco,method="rarefaction")
sp2<-specaccum(eco, method="exact")
sp3<-specaccum(eco,method="random")
sp4<-specaccum(eco,method="collector")
#Rarefacao Graficos
#par(mgp=c(1,1,0)) #exportar a imagem
#png(filename="/home/victor/Área de Trabalho/Bio/projeto_publ/2020_santa_teresa/acum4.png",width=800,height=600) #local e tmamanho
par(mfrow=c(2,2)) 
plot(sp1, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightblue",xlab="Amostras",ylab="Rarefação")
plot(sp2, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightgrey",xlab="Amostras",ylab="Riqueza Esperada")
plot(sp3, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="yellow",xlab="Amostras",ylab="Sítios Aleatórios")
plot(sp4, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightblue",xlab="Amostras",ylab="Curva do Coletor")
par(mfrow=c(1,1)) #compilado de curvas
#dev.off()

#Diversidade  Local 
H <- diversity(eco)
H #shannon
#Dominancia (mede a probabilidade de 2 (dois) individuos, selecionados ao acaso na amostra, pertencer a mesma especie)
simp <- diversity(eco, "simpson")
simp #simpson
#inverso do simpson
invsimp <- diversity(eco, "inv")
invsimp 
## Unbiased Simpson (Hurlbert 1971, eq. 5) with rarefy:
unbias.simp <- rarefy(eco, 2) - 1
unbias.simp
## Fisher alpha
alpha <- fisher.alpha(eco)
alpha
## Plot all
#pairs(cbind(H, simp, invsimp, unbias.simp, alpha), pch="+", col="blue")
## Species richness (S) and Pielou's evenness (J):
S <- specnumber(eco) ## rowSums(BCI > 0) does the same...
S
J <- H/log(S) #Pielou
J
#gráfico
eco<-reshape2::dcast(planilhatotal, Ecoregion ~ Species)
eco<-data.frame(eco, H, simp, unbias.simp, alpha, S, J)
#hist(grupo$alpha)

ggplot(eco, aes(x = H, y = S, color = Ecoregion)) + 
  geom_point(size=12)+
  #geom_text(data = data.frame(),
            #aes(label = eco$Ecoregion),
            #col = 'black',
            #size = 5) +
  #geom_boxplot() +
  ggtitle("Diversity") +
  xlab("Shannon diversity") +
  ylab("Richness") #+
  #theme(legend.position="none")

#cluster
pacman::p_load("ade4")
eco<-reshape2::dcast(planilhatotal, Ecoregion ~ Espécie)
eco=data.frame(eco, row.names=1)
d <- dist.binary(eco, method = 1, diag = FALSE, upper = FALSE) #method 1 is Jaccard index (1901) S3 coefficient of Gower & Legendre
hc <- hclust(d)               # apply hierarchical clustering 
plot(hc, labels=local$ID)    # plot the dendrogram


#Microregion
#Faixas altitudinais
eco<-reshape2::dcast(planilhatotal, Microregion_wwf ~ Species)
eco=data.frame(eco,row.names=1)
#eco #Diversidade espécie por faixa
#Abundância por Faixa
abund<-rowSums(eco) #abunância por faixa
abund
ts.plot(eco)
#Riqueza
specnumber<-specnumber(eco)
specnumber #Riqueza por Faixa
ts.plot(specnumber)
barplot(specnumber)
#Gráfico de Acumulação por Faixa
acumplot<-specaccum(eco) #dados de acumulação
acumplot
plot(acumplot) #curva simples
plot(acumplot,ci.type="poly",col="black",lwd=2,ci.lty=0,ci.col="lightgrey",ylab="Riqueza",
     xlab="Faixa de Altitude",main="Curva de Acumulação de Espécies",las=1,font=1.5,font.lab=1.5,cex.lab=1,cex.axis=1) #curva clássica
#Rarefacao faixas
sp1<-specaccum(eco,method="rarefaction")
sp2<-specaccum(eco, method="exact")
sp3<-specaccum(eco,method="random")
sp4<-specaccum(eco,method="collector")
#Rarefacao Graficos
#par(mgp=c(1,1,0)) #exportar a imagem
#png(filename="/home/victor/Área de Trabalho/Bio/projeto_publ/2020_santa_teresa/acum4.png",width=800,height=600) #local e tmamanho
par(mfrow=c(2,2)) 
plot(sp1, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightblue",xlab="Amostras",ylab="Rarefação")
plot(sp2, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightgrey",xlab="Amostras",ylab="Riqueza Esperada")
plot(sp3, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="yellow",xlab="Amostras",ylab="Sítios Aleatórios")
plot(sp4, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightblue",xlab="Amostras",ylab="Curva do Coletor")
par(mfrow=c(1,1)) #compilado de curvas
#dev.off()

#Diversidade  Local 
H <- diversity(eco)
H #shannon
#Dominancia (mede a probabilidade de 2 (dois) individuos, selecionados ao acaso na amostra, pertencer a mesma especie)
simp <- diversity(eco, "simpson")
simp #simpson
#inverso do simpson
invsimp <- diversity(eco, "inv")
invsimp 
## Unbiased Simpson (Hurlbert 1971, eq. 5) with rarefy:
unbias.simp <- rarefy(eco, 2) - 1
unbias.simp
## Fisher alpha
alpha <- fisher.alpha(eco)
alpha
## Plot all
#pairs(cbind(H, simp, invsimp, unbias.simp, alpha), pch="+", col="blue")
## Species richness (S) and Pielou's evenness (J):
S <- specnumber(eco) ## rowSums(BCI > 0) does the same...
S
J <- H/log(S) #Pielou
J
#gráfico
eco<-reshape2::dcast(planilhatotal, Microregion_wwf ~ Species)
eco<-data.frame(eco, H, simp, unbias.simp, alpha, S, J)
#hist(grupo$alpha)

ggplot(eco, aes(x = H, y = S, color = Microregion_wwf)) + 
  geom_point(size=12)+
  #geom_text(data = data.frame(),
  #aes(label = eco$Ecoregion),
  #col = 'black',
  #size = 5) +
  #geom_boxplot() +
  ggtitle("Diversity") +
  xlab("Shannon diversity") +
  ylab("Richness") #+
#theme(legend.position="none")

#cluster
pacman::p_load("ade4")
eco<-reshape2::dcast(planilhatotal, Microregion_wwf ~ Espécie)
eco=data.frame(eco, row.names=1)
d <- dist.binary(eco, method = 1, diag = FALSE, upper = FALSE) #method 1 is Jaccard index (1901) S3 coefficient of Gower & Legendre
hc <- hclust(d)               # apply hierarchical clustering 
plot(hc, labels=local$ID)    # plot the dendrogram

#Order

#Microregion
#Faixas altitudinais
order<-reshape2::dcast(planilhatotal, Order ~ Species)
order=data.frame(order,row.names=1)
#eco #Diversidade espécie por faixa
#Abundância por Faixa
abund<-rowSums(order) #abunância por faixa
abund
ts.plot(order)
#Riqueza
specnumber<-specnumber(order)
specnumber #Riqueza por Faixa
ts.plot(specnumber)
barplot(specnumber)
#Gráfico de Acumulação por Faixa
acumplot<-specaccum(order) #dados de acumulação
acumplot
plot(acumplot) #curva simples
plot(acumplot,ci.type="poly",col="black",lwd=2,ci.lty=0,ci.col="lightgrey",ylab="Riqueza",
     xlab="Faixa de Altitude",main="Curva de Acumulação de Espécies",las=1,font=1.5,font.lab=1.5,cex.lab=1,cex.axis=1) #curva clássica
#Rarefacao faixas
sp1<-specaccum(order,method="rarefaction")
sp2<-specaccum(order, method="exact")
sp3<-specaccum(order,method="random")
sp4<-specaccum(order,method="collector")
#Rarefacao Graficos
#par(mgp=c(1,1,0)) #exportar a imagem
#png(filename="/home/victor/Área de Trabalho/Bio/projeto_publ/2020_santa_teresa/acum4.png",width=800,height=600) #local e tmamanho
par(mfrow=c(2,2)) 
plot(sp1, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightblue",xlab="Amostras",ylab="Rarefação")
plot(sp2, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightgrey",xlab="Amostras",ylab="Riqueza Esperada")
plot(sp3, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="yellow",xlab="Amostras",ylab="Sítios Aleatórios")
plot(sp4, ci.type="poly", col="black", lwd=2, ci.lty=0, ci.col="lightblue",xlab="Amostras",ylab="Curva do Coletor")
par(mfrow=c(1,1)) #compilado de curvas
#dev.off()

#Diversidade  Local 
H <- diversity(order)
H #shannon
#Dominancia (mede a probabilidade de 2 (dois) individuos, selecionados ao acaso na amostra, pertencer a mesma especie)
simp <- diversity(order, "simpson")
simp #simpson
#inverso do simpson
invsimp <- diversity(order, "inv")
invsimp 
## Unbiased Simpson (Hurlbert 1971, eq. 5) with rarefy:
unbias.simp <- rarefy(order, 2) - 1
unbias.simp
## Fisher alpha
alpha <- fisher.alpha(order)
alpha
## Plot all
#pairs(cbind(H, simp, invsimp, unbias.simp, alpha), pch="+", col="blue")
## Species richness (S) and Pielou's evenness (J):
S <- specnumber(order) ## rowSums(BCI > 0) does the same...
S
J <- H/log(S) #Pielou
J
#gráfico
order<-reshape2::dcast(planilhatotal, Order ~ Species)
order<-data.frame(order, H, simp, unbias.simp, alpha, S, J)
#hist(grupo$alpha)

ggplot(order, aes(x = H, y = S, color = Order)) + 
  geom_point(size=12)+
  #geom_text(data = data.frame(),
  #aes(label = eco$Ecoregion),
  #col = 'black',
  #size = 5) +
  #geom_boxplot() +
  ggtitle("Diversity") +
  xlab("Shannon diversity") +
  ylab("Richness") #+
#theme(legend.position="none")



#Riqueza Estimada
#total
pool1<-specpool(faixa)
pool1
#pool1t<-t(pool1)
#boxplot(pool1t,xlab="Total")

##### Gráficos #####
#curva mid-domain (pesquisar Monte Carlo simulation)
#x=runif(200000, 0, 100)
#matrix=matrix(x, nrow=100000)

#sorted_matrix=matrix(1:200000, nrow=100000)

#for(i in 1:100000){
  #if(matrix[i, 1] <= matrix[i, 2])
     #sorted_matrix[i, ] = matrix[i, ]
     #else
       #sorted_matrix[i, ] =  c(matrix[i, 2], matrix[i, 1])
     #}

#sums=1:100
#for(i in 1:100){
  #sums[i]= sum(ifelse(sorted_matrix[, 1]<= i & sorted_matrix[, 2]>= i, 1, 0))
#}
#proportions= sums/10000

#plot(1:100, proportions, type="l", main="does 'equator' see disproportionate share of 'rondom species range?'", 
     #xlab="faux latitude", ylab="proportion of ranges found at given latitude")

#exemplo de estilo 
ggplot(planilhatotal, aes(x=Locality, y=Altitude, color=Data)) +  #Eixos x e y
  geom_point(#color="black",   #Cor do círculo
             #fill="#69b3a2",  #Cor do ponto
             shape=21,  #Formato do marcador
             alpha=0.5, #transparência
             size=4, #Tamanho
             stroke = 1) + #Largura do traço 
  theme_classic()

#ggsave("gap.png",width = 8, height = 5, dpi = 600)

ggplot(planilhatotal, aes(x=CodSp, y=Altitude)) +  #Eixos x e y
  geom_boxplot(aes(colour=Order)) + theme_classic()  
  #facet_grid(.~Order) 

ggplot(planilhatotal, aes(x=Altitude, y=Species)) +  #Eixos x e y
  geom_boxplot(aes(colour=Order)) + theme_classic()  #+geom_smooth(method = lm, se = TRUE)

#ggsave("boxplot1.png",width = 13, height = 5, dpi = 600)

pacman::p_load(ggExtra::ggMarginal(), quietly = T) #não funciona
pacman::p_load(ggExtra)
library(ggExtra) #, quietly = T)

#Esses dados levam em conta a abundância
p <- ggplot(planilhatotal, aes(x=Altitude, y=Species)) + #gráfico
  geom_point(size=1,alpha=0) + 
  geom_boxplot(aes(colour=Order)) + theme_classic()
#theme(legend.position="bottom")
p
# with marginal histogram
p1 <- ggMarginal(p, type="histogram")
# marginal density
p2 <- ggMarginal(p, type="density")
# marginal boxplot
p3 <- ggMarginal(p, type="boxplot")
#grid.arrange(p1, p2, p3, ncol=3) #não deu certo
p1
#ggsave("p1.png",width = 13, height = 5, dpi = 600)
p2
#ggsave("p2.png",width = 13, height = 5, dpi = 600)
p3

#par(mgp=c(1,1,0)) #exportar a imagem
#png(filename="/home/user/Área de Trabalho/Bio/projeto_publ/2020_altitude/p1.png",width=800,height=600) #local e tmamanho
p1
#dev.off()

Locality	Abundance	Richness	Sampling Effort	Factor	Shannon	Simpson	Alpha	Pielou	Min altitude	Max altitude	Mean Altitude
Fator 1	FNRP	28	5	5101	3 Locality	0.944	0.461	1.772	0.587	30	52	41
Fator 2	PEFG	402	14	4172	3 Locality	1.431	0.639	2.818	0.542	1160	1490	1325
Fator 3	PEMF	54	3	4312	3 Locality	0.741	0.414	0.684	0.674	112	153	132.5
Fator 4	PNC	383	20	13961	3 Locality	2.445	0.883	4.485	0.816	1000	2700	1850
Fator 5	RBDB	393	19	5960	3 Locality	2.114	0.828	4.169	0.683	557	631	594
Fator 6	RBCG	24	10	5101	3 Locality	2.188	0.878	6.436	0.95	45	68	56.5
Fator 7	RBCV	67	9	5101	3 Locality	1.846	0.799	2.797	0.84	68	115	91.5
Fator 8	0-500m	173	15	19615	2 Elevational Bands	2.088	0.805	3.943	0.771	30	153	91.5
Fator 9	500-1000m	393	19	5960	2 Elevational Bands	2.114	0.828	4.169	0.718	557	631	594
Fator 10	1000-1500m	380	16	7380	2 Elevational Bands	1.638	0.696	3.382	0.59	1000	1468	1234
Fator 11	1500-2000m	188	15	4785	2 Elevational Bands	2.095	0.839	3.833	0.773	1480	1800	1640
Fator 12	2000-2500m	210	11	5047	2 Elevational Bands	1.969	0.83	2.469	0.821	2000	2400	2200
Fator 13	2500-3000m	7	4	351	2 Elevational Bands	1.153	0.612	3.878	0.832	2700	2700	2700
Fator 14	Bottom 	566	26	25575	1 Group	2.501	0.885	5.626	0.767	30	631	330.5
Fator 15	Intermediary	509	19	7380	1 Group	1.73	0.72	3.892	0.587	1000	1468	1234
Fator 16	Upper	276	13	5398	1 Group	1.996	0.825	2.832	0.778	1800	2700	2250
Fator 17	Didelphomorphia	424	11	43708	4 Order	1.796	0.792	2.063	0.749	30	2100	1065
Fator 18	Rodentia	927	30	43708	4 Order	2.486	0.866	5.931	0.73	30	2700	1365

#tabela no excel
dados.clip <- read.table("clipboard", sep="\t", header=T)
dados.clip=data.frame(dados.clip)

ggplot(dados.clip, aes(x = Shannon, y = Richness)) + #size colocar outro dado
  #geom_vline(xintercept = 500, alpha=0.2) + geom_vline(xintercept = 1000, alpha=0.2) + geom_vline(xintercept = 1500, alpha=0.2) +
    #geom_vline(xintercept = 2000, alpha=0.2) +  geom_vline(xintercept = 2500, alpha=0.2) +
  geom_label_repel(aes(label = Locality), size=4, alpha= 0.7, #funciona no zoom
                   box.padding   = 0.35, 
                   point.padding = 0.75,
                   segment.color = 'grey50') +
  geom_point(aes(colour = Mean.Altitude, size = Sampling.Effort), alpha=0.6) +
  #geom_line(alpha=0.3, size=5) + #aes(size = dados.clip$Richness, alpha=0.7)) + 
    #scale_size(range = c(.1, 18), name = "Shannon") +
  ggtitle("Species richness, shannon diversity and sampling effort (trap-nights) by altitude for tratament groups") +
  xlab("Shannon") +
  ylab("Richness") +
  #theme(axis.title = element_text(size = 18),
        #axis.text = element_text(size = 16))+
  facet_grid(.~Factor) + theme_classic() 
  #theme(axis.text.x = element_text(angle = 75, vjust = .5)) +
  #scale_y_continuous("Sampling Effort") +
  #coord_flip() + ggtitle("Sampling Effort and shannon diversity for the data groups") +
  #theme(legend.position="Bottom") #theme_classic() 

#ggsave("grupo.png",width = 9, height = 5, dpi = 600)

a<-ggplot(dados.clip, aes(x = Mean.Altitude, y = Richness)) + 
  geom_point(aes(colour = Factor)) + #
  geom_smooth(method = loess, se = TRUE, alpha = 0.2) + theme_classic()
  #geom_smooth(method = lm, se = TRUE, colour = "red", alpha = 0.2) + theme_classic() #correlação negativa

b<-ggplot(dados.clip, aes(x = Mean.Altitude, y = Shannon)) + 
  geom_point(aes(colour = Factor)) + #
  geom_smooth(method = loess, se = TRUE, alpha = 0.2) + theme_classic()
#geom_smooth(method = lm, se = TRUE, colour = "red", alpha = 0.2) + theme_classic() #correlação negativa

c<-ggplot(dados.clip, aes(x = Mean.Altitude, y = Abundance)) + 
  geom_point(aes(colour = Factor)) + #
  geom_smooth(method = loess, se = TRUE, alpha = 0.2) + theme_classic()
#geom_smooth(method = lm, se = TRUE, colour = "red", alpha = 0.2) + theme_classic() #correlação negativa

d<-ggplot(dados.clip, aes(x = Mean.Altitude, y = Sampling.Effort)) + 
  geom_point(aes(colour = Factor)) + #
  geom_smooth(method = loess, se = TRUE, alpha = 0.2) + theme_classic()
#geom_smooth(method = lm, se = TRUE, colour = "red", alpha = 0.2) + theme_classic() #correlação negativa

pacman::p_load(gridExtra) 
grid.arrange(a, b, c, d ,
             ncol=2, nrow=2)

#ggsave("loesst.png",width = 9, height = 5, dpi = 600)

ggplot(dados.clip, aes(x = Richness, y = Mean.Altitude)) +
  geom_point(aes(size = Sampling.Effort, colour=Shannon), alpha=0.6) +
  geom_label_repel(aes(label = Locality), size=4, alpha= 0.7, #funciona no zoom
                   box.padding   = 0.35, 
                   point.padding = 0.75,
                   segment.color = 'grey50') +
  geom_smooth(method = lm, se = TRUE) +
  facet_grid(.~Factor) + theme_classic() 

#ggsave("tendencia.png",width = 9, height = 5, dpi = 600)


#teste de correlação, ver mais#teste de correlação, ver mais#teste de correlação, ver mais
dados.clip %>% 
  subset(Richness > 0) %$% #escolher a partir dos dados (relação de alt com as anos)
  cor.test(Richness, Mean.Altitude) #tem significância de riqueza

dados.clip %>% 
  subset(Mean.Altitude > 1500) %$% #Dados acima de 1500 tem correlação negativa de riqueza
  cor.test(Richness, Mean.Altitude) #tem significância de riqueza

dados.clip %>% 
  subset(Shannon > 0) %$% #escolher a partir dos dados (relação de alt com as anos)
  cor.test(Shannon, Mean.Altitude) #não tem significância

dados.clip %>% 
  subset(Mean.Altitude > 1500) %$% #escolher a partir dos dados (relação de alt com as anos)
  cor.test(Shannon, Mean.Altitude) #tem significância

#Significância entre altitude e espécie
pacman::p_load(jtools, sandwich, lme4, svyglm, ggstance) #plot lm
#os some A. cursos, acho que o (intecep é ele)
a<-summary(aov(dados.clip$Mean.Altitude ~ factor(dados.clip$Richness))) #signifcância da assembléia por altitude
a #não significativo
a<-summary(lm(dados.clip$Mean.Altitude ~ dados.clip$Richness)) #signifcância das espécies por altitude
a #não significativo
#anova(lm(dados.clip$Sampling.Effort ~ dados.clip$Shannon)) #signifcância das espécies por altitude
a<-lm(dados.clip$Mean.Altitude ~ dados.clip$Richness)
#plot(a, which=c(1,2,3,4,5,6))
summ(a) #não significativo
summ(a, robust = "HC1") #não significativo
#summ(a, scale = TRUE, n.sd = 2)
#summ(a, center = TRUE)
#summ(a, confint = TRUE, digits = 3)
#glm(planilhatotal$Altitude ~ planilhatotal$Species)
b<-glm(dados.clip$Mean.Altitude ~ dados.clip$Richness)
summ(b) #não significativo
#summ(b, exp = TRUE)
#c<-lmer(planilhatotal$Altitude ~ planilhatotal$Species) #randomização, não deu certo
#plot_summs(b)
#plot_summs(b, scale = TRUE)
#plot_summs(b, scale = TRUE, inner_ci_level = .9)
plot_summs(b, scale = TRUE, plot.distributions = TRUE, inner_ci_level = .9)

fit <- lm(Mean.Altitude ~ Richness + Abundance + Shannon + Alpha + Pielou, data = dados.clip) 
summ(fit)
fit$coefficients
#effect_plot(fit, pred = Order, interval = TRUE, plot.points = TRUE) #não faz sentido
plot_summs(fit, scale = TRUE, plot.distributions = TRUE, inner_ci_level = .9)

dados.clip %>% 
  subset(Richness >= 0) %$% #escolher a partir dos dados (relação de alt com as anos)
  cor.test(Richness, Sampling.Effort) # 0- baixa xorrelação / 1- alta correlação


#Gráficos violinos
violin <- ggplot(planilhatotal, aes(x=Altitude, y=Locality, color=Group)) + #violino, não deu o marginal
  geom_point() + #trim=FALSE) +
  #geom_boxplot(width=0.1,
               #fill="white") +
  labs(title="Abundância por altitude",x="Ordem", y = "Altitude")
violin + theme_classic()

install.packages("rangemodelR")

#Carregar e inserir imagem de fundo
pacman::p_load(png,ggpubr) #colocar a imagem
img <- readPNG("/home/victor/Área de Trabalho/Bio/projeto_publ/2020_altitude/montanha.png")
grid::grid.raster(img)

violin <- ggplot(planilhatotal, aes(x=Locality, y=Altitude)) + #violino, não deu o marginal
  background_image(img) +
  geom_violin() +
  geom_jitter(aes(color=Data) , size=2, width=0.3) +
  #geom_boxplot(width=0.1) +
  labs(title="Elevational Gradient",x="Locality", y = "Elevational")
violin + theme_classic()

violin <- ggplot(planilhatotal, aes(x=Locality, y=Altitude, color=Data)) + #violino, não deu o marginal
  background_image(img) +
  geom_point(alpha=0.5) +
  #geom_boxplot(width=0.1) +
  labs(title="Abundância por altitude",x="Ordem", y = "Altitude")
violin + theme_classic()

violin <- ggplot(planilhatotal, aes(x=Locality, y=Altitude, color=Group)) + #violino, não deu o marginal
  background_image(img) +
  geom_violin(alpha=0.5,
             size=6) +
  #geom_boxplot(width=0.1) +
  labs(title="Abundância por altitude",x="Ordem", y = "Altitude")
violin + theme_classic()

mean_wt <- data.frame(nome = c(1, 2, 3, 4, 5), faixa = c(500, 1000, 1500, 2000, 2500))

violin <- ggplot(planilhatotal, aes(x= Class, y=Altitude, color= Ecoregion, fill= Ecoregion)) + #violino, não deu o marginal
  geom_violin(alpha=0.5) +
  geom_hline(yintercept = 500, alpha=0.5) + geom_hline(yintercept = 1000, alpha=0.5) + geom_hline(yintercept = 1500, alpha=0.5) + 
  geom_hline(yintercept = 2000, alpha=0.5) +  geom_hline(yintercept = 2500, alpha=0.5) +
  facet_grid(.~Group) +
  labs(title="Elevational gradient for group, ecoregion and bands",x="Order", y = "Altitude")
violin + theme(legend.position="bottom") #trocar as espécies por números e colocar os nomes na legenda

#salvar imagem
#violin + theme_classic() +
#ggsave("violin2.png",width = 6, height = 4, dpi = 300)

###Plano Cartesiano
ggplot(planilhatotal, aes(x = Locality, y = Altitude, colour=Extrato)) + #plot de comparação catálogo com altitude
  geom_point(size=4)

ggplot(planilhatotal, aes(x = CodSp, y = Altitude, colour=Espécie)) + #escolher parâmetros
  geom_point(size=4,
             alpha=0.5) + #escolher tipo de plotage
  theme(legend.position = "bottom") + #tema do pacote
  facet_wrap(~Locality, ncol=3) #facetar o gráfico para finalmente plotar
#?theme
# Um scatterplot básico, onde a cor depende da Species
ggplot(planilhatotal, aes(x=CodSp, y=Altitude, color=Locality)) +
  geom_point(size=6)

# Vários
ggplot(planilhatotal, aes(x=CodSp, y=Altitude, 
                 shape=Family,
                 color=Espécie)) +
  geom_point(size=6,
             alpha=0.15)
             
### Pontos conectados
pacman::p_load("dplyr")

planilhatotal %>%
  arrange(desc(Altitude)) %>% #organizador
  ggplot(aes(x=Extrato, y=Altitude, colour = Order)) +
  geom_line(alpha=0.5) +
  geom_point(size=3) +
  ggtitle("Gradiente Altitudinal")

### Bolhas
# Size
ggplot(planilhatotal, aes(x=CodSp, y=Altitude, size=Espécie, color = Order)) +
  geom_point(alpha=0.7)

#options(scipen = 10) 
planilhatotal %>%
  arrange(order(Altitude)) %>%
  mutate(CatalogNumber = log(CatalogNumber)) %>% #Fazer testes com o vegan
  ggplot(aes(x = CodSp, y = Altitude, color = Species, shape = Locality, size = CodSp)) + #size colocar outro dado
  geom_point(alpha = 0.5) + #não está funcionando, precisa do mutate
  scale_size(range = c(.1, 18), name = "Population (M)")

#exemplo professor, problema com o tema library(hrbrthemes) não funciona
pacman::p_load(viridis, tidyverse)

planilhatotal %>%
  arrange(desc(Altitude)) %>%
  mutate(Altitude = factor(Altitude)) %>% #mais testes
  ggplot(aes(x=CodSp, y=Altitude, size=CatalogNumber, fill=Espécie)) +
  geom_point(alpha=0.2, shape=21, color="black") +
  scale_size(range = c(.1, 24), name="Altitude") +
  scale_fill_viridis(discrete=TRUE, guide=FALSE, option="A") +
  #theme_ipsum() + #pacote não funciona
  theme(legend.position="bottom") +
  ylab("Faixa Altitudinal") +
  xlab("Altitude") + 
  theme(legend.position = "bottom") #pra ter legenda

#apontar outlines
pacman::p_load(ggrepel, quietly = T)

##### Plot Marginal ######
ggplot(data=planilhatotal, aes(x=CodSp, Altitude)) +
  geom_point(size=12, alpha=0.01) +
  geom_rug(col="steelblue",alpha=0.1, size=1.5)

##### Evitar o overploting #####
#diminuindo o ponto
planilhatotal %>%
  ggplot(aes(x=Genus, y=Altitude)) +
  geom_point(color="#69b3a2", size=0.02) +
  #theme_ipsum() +
  theme(legend.position="none")

#transparencia
planilhatotal %>%
  ggplot( aes(x=Extrato, y=Altitude)) +
  geom_point(color="#69b3a2", size=4, alpha=0.01) +
  #theme_ipsum() +
  theme(
    legend.position="none"
  )

#densidade 2D
ggplot(planilhatotal, aes(x=Extrato, y=Altitude) ) +
  stat_density_2d(aes(fill = ..density..), geom = "raster", contour = FALSE) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_viridis() +
  theme(legend.position='none')

#Amostragem
planilhatotal %>%
  sample_frac(0.05) %>% #5% da plotagem
  ggplot(aes(x=Extrato, y=Altitude)) +
  geom_point(color="#69b3a2", size=2) +
  #theme_ipsum() +
  theme(legend.position="none")

#Destacando um grupo
planilhatotal %>%
  ggplot(aes(x=Locality, y=Altitude)) +
  geom_point(color="grey", size=2) +
  geom_point(data = planilhatotal %>% filter(Order=="Didelphimorphia"), color="#69b3a2", size=2) +
  #theme_ipsum() +
  theme(legend.position="none", plot.title = element_text(size=12)) +
  ggtitle('Behavior of the group B')

planilhatotal %>%
  ggplot( aes(x=Locality, y=Altitude, color=Family)) +
  geom_point( size=2, alpha=0.1) +
  scale_color_viridis(discrete=TRUE) #+
#theme_ipsum()

#Facetagem NÃO CONSEGUI
data2 <- data %>% select(-group) #exemplo, não consegui
data2 <- data[,-3]

data2 <- planilhatotal %>% 
  select(Order="Rodentia") #escolhi só os Rodentia

planilhatotal %>%
  ggplot(aes(x=Extrato, y=Altitude)) +
  geom_point(data=data2, size=1, alpha=0.05, color="grey") +
  geom_point(aes(color=Locality) , size=2, alpha=0.1) +
  scale_color_viridis(discrete=TRUE) +
  #theme_ipsum() +
  theme(legend.position="none") +
  facet_wrap(~Locality)

#Tremer os dados (jitter)
p1 <- planilhatotal %>%
  ggplot(aes(x=Locality, y=Altitude)) +
  geom_point(aes(color=Altitude) , size=2, alpha=0.2) +
  scale_color_viridis() +
  #theme_ipsum() +
  theme(legend.position="none")
p1
# tREMIDA
p2 <- planilhatotal %>%
  ggplot(aes(x=Locality, y=Altitude)) +
  geom_jitter(aes(color=Extrato) , size=2, alpha=0.2, width=0.3) +
  scale_color_viridis() +
  #theme_ipsum() +
  theme(legend.position="none")
p2 

###### Outros ######
p<-poolaccum(altitude, permutations = 50)
p
p.plot<-plot(p, display = c("chao", "jack1", "jack2"))
p.plot
chao <- data.frame(summary(p)$chao,check.names = FALSE)
colnames(chao) <- c("N", "Chao", "lower2.5", "higher97.5", "std")
chao_melt <- melt(chao, id.vars = c("N","std"))
ggplot(data = chao_melt, aes(x = N, y = value, group = variable)) +
  geom_line(aes(color = variable))


#gráfico
pacman::p_load("agricolae")
anova_result <- aov(Locality ~ H, local)
summary(anova_result)
tukey_result <- HSD.test(anova_result, "Altitude", group = TRUE)
print(tukey_result)

group_data <- tukey_result$groups[order(rownames(tukey_result$groups)),]

ggplot(planilhatotal, aes(x = , y = Extrato1)) +
  geom_text(data = data.frame(),
            aes(x = rownames(group_data), y = max(planilhatotal$Extrato1) + 1, label = group_data$groups),
            col = 'black',
            size = 10) +
  geom_boxplot() +
  ggtitle("Alpha diversity") +
  xlab("Site") +
  ylab("Alpha diversity index")

###### Graphis paper ####



